////////////////				242.lorentz _ chaotic color image deviation////		//		//////								10/03/2001 / s//////	criei variaveis xx,yy,zz internas }a estructura para//	armazenar os valores do caos xyz em long...//  dial 			map_beta(x->low, x->high, x->a, x->b)		//   cauchy.  A * tan((rnd-.5)*pi)#include "Movies.h"#include "ext_common.h"#include "ext.h"#include "ext_user.h"#include <math.h>#include <stdlib.h>#include "n2.basicstrings.c"#include "n2.0000.h"     // nato.inkludes//object data structuretypedef struct zttz {	Object   n_ob;     // required max 	void     *n2hdr;   // required nato - position = important _ must b 2nd		void             *dataout;          // n2data outlet	n2imgptr         gvelt;             // img buffer		double		sigma, r, b, nx, ny, nz,dt;	long			scale,xx,yy,zz,divx, divy,dtt;	//    Boolean          mode;    Boolean          on,bypass,freeze,think,quarrel;  // nato.objstate flagz       } NNato;// prototypesvoid *nnato_new(long scale)		;			//argumentsvoid nnato_assist(NNato *x, void *b, long msg, long nr, char *s);void nnato_info(NNato *x, void *p, void *b);void nnato_free(NNato *x);void nnato_processimage(NNato *x, n2atom *data);void nnato_processimage2(NNato *x, n2atom *data);void nnato_processimage3(NNato *x, n2atom *data);void nnato_processimage4(NNato *x, n2atom *data);void nnato_processimage5(NNato *x, n2atom *data);void nnato_processimage6(NNato *x, n2atom *data);void nnato_processimage7(NNato *x, n2atom *data);void nnato_processimage8(NNato *x, n2atom *data);void nnato_on(NNato *x, long flag);void nnato_bypass(NNato *x, long flag);void nnato_freeze(NNato *x, long flag);void nnato_think(NNato *x, short val);void nnato_quarrel(NNato *x, short val);void nnato_bang(NNato *x);void nnato_int(NNato *x, long n);   void nnato_variant(NNato *x, short variant);                    //experimenta s— tirar o ;  ....     void  nnato_sigma(NNato *x, double val);void nnato_r(NNato *x, double val);void nnato_b(NNato *x, double val);void nnato_dtt(NNato *x, long val);void nnato_nx(NNato *x, double val);void nnato_ny(NNato *x, double val);void nnato_nz(NNato *x, double val);void nnato_divy(NNato *x,long val);void nnato_divx(NNato *x,long val);void nnato_div(NNato *x, long val);void nnato_scale(NNato *x, long scale);void nnato_default(NNato *x);//void nnato_xx(NNato *x,long val);//void nnato_yy(NNato *x,long val);//void nnato_zz(NNato *x,long val);long calcround(NNato *x);					// long xx, long yy, long zzdouble calc(NNato *x);		void     *nnato_class;main(void){	setup(&nnato_class, nnato_new, (method)nnato_free, (short)sizeof(NNato), 0L, 	A_DEFLONG,0);    n2objaddimagecmd();    n2addstatecmd((method)nnato_int,(method)nnato_bang,                  (method)nnato_on,(method)nnato_freeze,(method)nnato_bypass,                  (method)nnato_think,(method)nnato_quarrel,(method)nnato_variant,0); 	addmess((method)nnato_assist,	                   "assist",    	A_CANT,0); 	addmess((method)nnato_info,	                       "info",		    A_CANT,0);    addmess((method)nnato_sigma,                    "sigma",           A_DEFFLOAT,0);				//mensagens    addmess((method)nnato_r,                  "r",         A_DEFFLOAT,0);     addmess((method)nnato_b,                   "b",          A_DEFFLOAT,0);    addmess((method)nnato_nx,                   "x",          A_DEFFLOAT,0);     addmess((method)nnato_ny,                   "y",          A_DEFFLOAT,0);     addmess((method)nnato_nz,                   "z",          A_DEFFLOAT,0);          addmess((method)nnato_dtt,                   "dt",          A_DEFLONG,0);          addmess((method)nnato_scale,                   "+",          A_DEFLONG,0);          addmess((method)nnato_divx,                   "/x",          A_DEFLONG,0);     addmess((method)nnato_divy,                   "/y",          A_DEFLONG,0);     addmess((method)nnato_div,                   "/",          A_DEFLONG,0);     addmess((method)nnato_default, 			"reset"		, 0);    n2addfklass("242.lorentz");//    post("");    post(" //sier,2001                 242 - lorentz");//    post(" «  ");}void nnato_assist(NNato *x, void *b, long msg, long nr, char *s){	if (msg == 1)      // inlet			sprintf(s, "nato.imag   .var%ld", x->nx);    else       {	   if (msg == 2)   // outlet	      if (nr == 0)	      	if  (!x->quarrel)			      	sprintf(s, "no quarrel & high  %ld",x->ny);		        else  sprintf(s, " quarrelling & & high  %ld",x->nz);       }}void nnato_info(NNato *x, void *p, void *b){      n2info();}void *nnato_new(long scale)	{	NNato      *x;    short      err;//    double 	sigma, r , b, nx, ny, nz;    	x = (NNato *)newobject(nnato_class);    n2addoutlet(x,&x->dataout);        if (err = n2objinit(x))       { post("242.lorentz  :  n2initobjekt err = %ld",err); return;}            if ((err = n2inewimage(&x->gvelt,n2idefwidth,n2idefheight)))       { post("242.lorentz  :  n2inewimage err = %ld",err); goto ikk;}      n2objsetimagefun(x,(method)nnato_processimage); //    nnato_default(x);//			x->divx e y				x->sigma=10.0;		 x->r=28.0; 		 x->b= 2.67; 		 x->nx=0.1; 		 x->ny=0.1; 		 x->nz=0.1;		 x->dt=0.01;		x->scale = scale; 		x->xx = x->yy = x->zz = 0;	      x->on = true; 	   x->bypass = x->freeze = x->think = x->quarrel = false;      	 //	calc(x);   //seeding ...	      return (x);ikk:	nnato_free(x);}void nnato_free(NNato *x){    if (x->gvelt) { n2idisposeimage(x->gvelt); x->gvelt = 0;}    n2objfree(x);}void nnato_on(NNato *x, long flag){        x->on = flag;}    void nnato_bypass(NNato *x, long flag){        x->bypass = flag;}      void nnato_freeze(NNato *x, long flag){        x->freeze = flag;} void nnato_int(NNato *x, long n)    {								       n2defintstatefun(x,n);}void nnato_bang(NNato *x){   n2registerimage(x,n2objtype,x->dataout,0,x->gvelt);			// &what!?          ,&data,}void nnato_default(NNato *x){	x->sigma = 10.0;	x->r = 27.5;	x->b = 2.67;	x->nx = 0.01;	x->ny = 0.01;	x->nz = 0.03;        x->dt=0.01;	x->scale = 0;//	post("242.lorenz:default arguments, sigma=%.1f r=%.1f b=%.1f, x=%.1f y=%.1f z=%.1f dt=%.1f +=%.1i", //			x->sigma, x->r, x->b, x->nx, x->ny, x->nz,x->dt, x->scale);		}double calc( NNato *x){      double xdot,		ydot,		zdot,		delta_t;				xdot = 0;	ydot = 0;	zdot = 0;	delta_t = x->dt;    // ou x->dt		xdot = (x->ny - x->nx) * x->sigma;	ydot = (x->r * x->nx) - x->ny - (x->nx * x->nz);	zdot = (x->nx * x->ny) - (x->b * x->nz);//	post("lorenz:lorenz_calc1, x=%f y=%f z=%f xdot=%f ydot=%f zdot=%f ", //			x->a_newx, x->a_newy, x->a_newz, xdot, ydot, zdot);	xdot = xdot * delta_t;	ydot = ydot * delta_t;	zdot = zdot * delta_t;		x->nx = x->nx + xdot;	x->ny = x->ny + ydot;	x->nz = x->nz + zdot;	}long calcround (NNato *x){	//long xx, yy, zz;			calc(x);	x->xx = (x->nx ) + x->scale;	x->yy = (x->ny ) + x->scale;	x->zz = (x->nz ) + x->scale;//	x->xx = (x->nx + 0.5) + x->scale;//	x->yy = (x->ny + 0.5) + x->scale;//	x->zz = (x->nz + 0.5) + x->scale;}void nnato_scale(NNato *x, long scale){        x->scale = scale;} void nnato_sigma(NNato *x, double val){	x->sigma = val;       	                }void nnato_r(NNato *x, double val){	x->r = val;                  	     }void nnato_b(NNato *x, double val){	x->b = val;                      	 }	void nnato_nx(NNato *x, double val){	x->nx = val;                      	 }	void nnato_ny(NNato *x, double val){	x->ny = val;                      	 }		void nnato_nz(NNato *x, double val){	x->nz = val;                      	 }	void nnato_dtt(NNato *x, long val){	x->dtt = val;	x->dt = val / 100000. ;                     //dt is     100 dt = 0.001   3000 = 0. 0 3//	post("dt: %f",(float) x->dt);	 }	void nnato_divx(NNato *x,long val){	x->divx = val;                      	 }	void nnato_divy(NNato *x,long val){	x->divy = val;                      	 }	void nnato_div(NNato *x, long val){        x->divx=x->divy = val;}/*void nnato_xx(NNato *x,long val){	x->xx = val;                      	 }	void nnato_yy(NNato *x,long val){	x->yy = val;                      	 }	void nnato_zz(NNato *x,long val){	x->zz = val;                      	 }	*/	void nnato_variant(NNato *x, short variant){   if (!variant)       n2objsetimagefun(x,(method)nnato_processimage);    else if (variant == 1)       n2objsetimagefun(x,(method)nnato_processimage2);        else if (variant == 2)       n2objsetimagefun(x,(method)nnato_processimage3);          else if (variant == 3)       n2objsetimagefun(x,(method)nnato_processimage4);          else if (variant == 4)       n2objsetimagefun(x,(method)nnato_processimage5);              else if (variant == 5)       n2objsetimagefun(x,(method)nnato_processimage6);          else if (variant == 6)       n2objsetimagefun(x,(method)nnato_processimage7);          else if (variant == 7)       n2objsetimagefun(x,(method)nnato_processimage8);}void nnato_think(NNato *x, short val){   x->think = val;}void nnato_quarrel(NNato *x, short val){   x->quarrel = val;}void nnato_processimage(NNato *x, n2atom *data){                       long           i, j, roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;                              Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);        		              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                      	calcround(x);                                      for(j = 0; j < width; j++)                 {                    pix = n2get32(src);					n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   + mapx),					         n2klamp255(n2get32green(pix) + mapy),					         n2klamp255(n2get32blue(pix)  + mapz));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage2(NNato *x, n2atom *data){                       long           i, j, k,roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;           Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);        	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                            k = i % x->divx;            if (k==0)                     calcround(x);                                      for(j = 0; j < width; j++)                 {                    pix = n2get32(src);					n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   + mapx),					         n2klamp255(n2get32green(pix) + mapy),					         n2klamp255(n2get32blue(pix)  + mapz));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage3(NNato *x, n2atom *data){                       long           i, j,k, roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;                Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);        	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                                                  for(j = 0; j < width; j++)                 {                 k = i % x->divy;                 		if (k==0)                  			  calcround(x);                 			                    pix = n2get32(src);					n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   + mapx),					         n2klamp255(n2get32green(pix) + mapy),					         n2klamp255(n2get32blue(pix)  + mapz));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage4(NNato *x, n2atom *data){                       long           i, j, k, l,roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;                  Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);        	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;            k = i % x->divx;            if (k==0)                      	 calcround(x);                                      for(j = 0; j < width; j++)                 {                 l = j % x->divy;                 if (l==0)                 				calcround(x);                      pix = n2get32(src);					n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   + mapx),					         n2klamp255(n2get32green(pix) + mapy),					         n2klamp255(n2get32blue(pix)  + mapz));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage5(NNato *x, n2atom *data){                       long           i, j, k,l,roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;           Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);                	 calcround(x);   	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                        k = i % x->divx;            if (k==0)                      	calcround(x);;                                      for(j = 0; j < width; j++)                 {                 l = j % x->divy;                 if (l==0)                 				calcround(x);                    pix = n2get32(src);                    		n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   <<  (n2get32red(pix) *mapx)),					         n2klamp255(n2get32green(pix) << (n2get32green(pix) *mapy)),					         n2klamp255(n2get32blue(pix)  << (n2get32blue(pix) *mapz)));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage6(NNato *x, n2atom *data){                       long           i, j, k, l,roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;           Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                for(j = 0; j < width; j++)                 {	                 l = j % x->divy;                 if (l==0)                 				calcround(x);                    pix = n2get32(src);                    		n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   +  (n2get32red(pix) -mapx)/mapx),					         n2klamp255(n2get32green(pix) + (n2get32green(pix) -mapy)/mapy),					         n2klamp255(n2get32blue(pix)  + (n2get32blue(pix) -mapz)/mapz));										    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage7(NNato *x, n2atom *data){                       long           i, j, k, l,roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;           Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                for(j = 0; j < width; j++)                 {                l = i % x->divy;                if (l==0)                 				calcround(x);                      pix = n2get32(src); 					n2set32m(dst,					         (n2get32alpha(pix) *mapx),       //alpha agitation ++					         n2klamp655(n2get32red(pix)   + mapx),					         n2klamp655(n2get32green(pix) + mapy),					         n2klamp655(n2get32blue(pix)  + mapz));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}		void nnato_processimage8(NNato *x, n2atom *data){                       long           i, j, k,l,roubitez, pix;                              short         width, height, err;     long 		mapx=x->xx, mapy=x->yy, mapz=x->zz ;           Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate,dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);         if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.lorentz  : n2iensureimagedimeq err = %ld", err);             return;           }                  if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;          dstpixmap   = n2igetpixmap(dstgvelt);                srcpixztate = n2igetpixstate(srcpixmap);        dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;                  if (!n2ilockpix(dstpixmap)) goto ikk;                        srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);                	 calcround(x);   	              for(i = 0; i < height; i++)   				             {                src = srcadresz + i * roubitez;                            dst = dstadresz + i * roubitez;                        k = i % x->divx;            if (k==0)                      	calcround(x);;                                      for(j = 0; j < width; j++)                 {                 l = j % x->divy;                 if (l==0)                 				calcround(x);                    pix = n2get32(src);                    		n2set32m(dst,					         n2get32alpha(pix),					         n2klamp255(n2get32red(pix)   >>  (n2get32red(pix) *mapx)),					         n2klamp255(n2get32green(pix) >> (n2get32green(pix) *mapy)),					         n2klamp255(n2get32blue(pix)  >> (n2get32blue(pix) *mapz)));									    src+=4;				    dst+=4;					                 }		     }				   	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}	