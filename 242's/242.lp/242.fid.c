/*first attempt at implementing a buffer that will store rgb images2200 20010626. sier*/#include "Movies.h"#include "ext_common.h"#include "ext.h"#include "ext_user.h"#include "n2.basicstrings.c"#include "n2.0000.h"     // n2.inkludes#include <vector.h> //buffer purposestypedef struct zttz {	Object   n_ob;     // required max 	void     *n2hdr;   // required nato - position = signifikant _ must b 2nd		void             *dataout;      // n2data outlet	 	n2imgptr         gvelt;         // img buffer    short            redgain;       // var!ablz    short            greengain;       short            bluegain;    short			*buffer;	//buffer vector    Boolean          on,bypass,freeze,think,quarrel;  // nato.objstate flagz} NNato;void *nnato_new(long red, long green, long blue);void nnato_assist(NNato *x, void *b, long msg, long nr, char *s);void nnato_info(NNato *x, void *p, void *b);void nnato_free(NNato *x);void nnato_processimage(NNato *x, n2atom *data);void nnato_processimage2(NNato *x, n2atom *data);void nnato_processimage3(NNato *x, n2atom *data);void nnato_processimage4(NNato *x, n2atom *data);void nnato_on(NNato *x, long flag);void nnato_bypass(NNato *x, long flag);void nnato_freeze(NNato *x, long flag);void nnato_int(NNato *x, long n);void nnato_bang(NNato *x);void nnato_think(NNato *x, short val);void nnato_quarrel(NNato *x, short val);void nnato_variant(NNato *x, short variant);void nnato_redgain(NNato *x,   short gain);void nnato_greengain(NNato *x, short gain);void nnato_bluegain(NNato *x,  short gain);void nnato_gain(NNato *x, short gain);void memory_ONE(double *input,double *output);void     *nnato_class;main(void){	setup(&nnato_class, nnato_new, (method)nnato_free, (short)sizeof(NNato), 0L, 	      A_DEFLONG, 0); // obj argument = maxnr of frames 	addmess((method)nnato_assist,	                   "assist",    	A_CANT,0); 	addmess((method)nnato_info,	                       "info",		    A_CANT,0);    n2objaddimagecmd();    n2addstatecmd((method)nnato_int,(method)nnato_bang,                  (method)nnato_on,(method)nnato_freeze,(method)nnato_bypass,                  (method)nnato_think,(method)nnato_quarrel,(method)nnato_variant,0);    addmess((method)nnato_redgain,                     "red",           A_DEFLONG,0);    addmess((method)nnato_greengain,                   "green",         A_DEFLONG,0);    addmess((method)nnato_bluegain,                    "blue",          A_DEFLONG,0);    addmess((method)nnato_gain,                        "rgb",           A_DEFLONG,0);    addmess((method)nnato_getframe,                        "frame",           A_DEFLONG,0);    	post  ("242.fid> sier, 2001");//    n2reklama();    n2addfklass("242.fid");}void nnato_assist(NNato *x, void *b, long msg, long nr, char *s){	if (msg == 1)      // !nlet	   sprintf(s, "n2.i");        else       {	   if (msg == 2)   // outlet	      if (nr == 0)	        sprintf(s, "n2.o");    // default `image data type` outlet de[a]ss!zt--       }}void nnato_info(NNato *x, void *p, void *b){      n2info();}void *nnato_new(long red, long green, long blue){	NNato      *x;    short      err;  		x = (NNato *)newobject(nnato_class);    n2addoutlet(x,&x->dataout);        if (err = n2objinit(x))       { post("242.fid  :  n2objinit err = %ld",err); return;}            if ((err = n2inewimage(&x->gvelt,n2idefwidth,n2idefheight)))       { post("242.fid  :  n2inewimage err = %ld",err); goto ikk;}      n2objsetimagefun(x,(method)nnato_processimage);    x->redgain   = red;    x->greengain = green;    x->bluegain  = blue;        	x->on = true;    x->bypass = x->freeze = x->think = x->quarrel = false;           return (x);ikk:	nnato_free(x);}void nnato_free(NNato *x){    if (x->gvelt) { n2idisposeimage(x->gvelt); x->gvelt = 0;}    n2objfree(x);}void nnato_on(NNato *x, long flag){        x->on = flag;}    void nnato_bypass(NNato *x, long flag){        x->bypass = flag;}      void nnato_freeze(NNato *x, long flag){        x->freeze = flag;} void nnato_int(NNato *x, long n){   n2defintstatefun(x,n);}void nnato_bang(NNato *x){   n2registerimage(x,n2objtype,x->dataout,0,x->gvelt);}void nnato_think(NNato *x, short val){   x->think = val;}void nnato_quarrel(NNato *x, short val){   x->quarrel = val;}void nnato_variant(NNato *x, short variant){   if (!variant)       n2objsetimagefun(x,(method)nnato_processimage);    else if (variant == 1)       n2objsetimagefun(x,(method)nnato_processimage2);   else if (variant == 2)       n2objsetimagefun(x,(method)nnato_processimage3);   else if (variant == 3)       n2objsetimagefun(x,(method)nnato_processimage4);}void nnato_redgain(NNato *x, short gain){   x->redgain = gain;}void nnato_greengain(NNato *x, short gain){   x->greengain = gain;}void nnato_bluegain(NNato *x, short gain){   x->bluegain = gain;}void nnato_gain(NNato *x, short gain){   x->redgain = x->greengain = x->bluegain = gain;}void memory_store (short frame, short height, short width, short red, short green, short blue){if (frame<0 || frame>x->FRAMEMAX || height>x->height || width>x->width) goto klank;else{  int f,g;  for(f=0;f<3;f++)    {    output[f] = input[0]*matrix[f*3+0]+                input[1]*matrix[f*3+1]+                input[2]*matrix[f*3+2];    }	x->buffer[frame][height][width][0] = red;	x->buffer[frame][height][width][1] = green;	x->buffer[frame][height][width][2] = blue;	}klank:;}void memory_ONE(double *input,double *output){ int f,g;  double store[3];for  (f=0; f<3; f++){    output[f] = store[f];		}for  (g=0; g<3; g++){    store[g] = input[g];		}    	}		void nnato_processimage(NNato *x, n2atom *data) {                       long           i, j, roubitez, pix, xc, yc, zc, rini, gini, bini;                               short          redgain   = x->redgain,     			   greengain = x->greengain,     			   bluegain  = x->bluegain,                   width, height, err;                        Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate, dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);	short  input[3],output[3]; //(diss)assembling channels        if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.fid  : n2iensureimagedimeq err = %ld", err);             return;           }           if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;                         dstpixmap   = n2igetpixmap(dstgvelt);         srcpixztate = n2igetpixstate(srcpixmap);                dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;               if (!n2ilockpix(dstpixmap)) goto ikk;                      srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);                    for(i = 0; i < height; i++)          {            src = srcadresz + i * roubitez;                        dst = dstadresz + i * roubitez;                                  for(j = 0; j < width; j++)            {                pix = n2get32(src);                input[0] = n2get32red(pix);                input[1] = n2get32green(pix);                input[2] = n2get32blue(pix);		memory_store(frame, i, j, input); // storing pixel values in frame at									// i row, j column				tristimulus_product(x->matrix,input,output);				xc=output[0]; 				yc=output[1]; 				zc=output[2]; 					memory_store(frame, i, j, rini, gini, bini); // storing pixel values in frame at														// i row, j column/*				memory_ONE(input,output);				xc=output[0]; 				yc=output[1]; 				zc=output[2]; */				n2set32m(dst,				         n2get32alpha(pix),				         n2klamp255(xc - rini + redgain),				         n2klamp255(yc - gini + greengain),				         n2klamp255(zc - bini + bluegain));                input[0] = rini;                input[1] = gini;                input[2] = bini;				src+=4;				dst+=4;					             }		 }  	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}void nnato_processimage2(NNato *x, n2atom *data) {                       long           i, j, roubitez, pix, xc, yc, zc, rini, gini, bini;                               short          redgain   = x->redgain,     			   greengain = x->greengain,     			   bluegain  = x->bluegain,                   width, height, err;                        Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate, dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);	double  input[3],output[3];        if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.fid  : n2iensureimagedimeq err = %ld", err);             return;           }           if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;                         dstpixmap   = n2igetpixmap(dstgvelt);         srcpixztate = n2igetpixstate(srcpixmap);                dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;               if (!n2ilockpix(dstpixmap)) goto ikk;                      srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);                    for(i = 0; i < height; i++)          {            src = srcadresz + i * roubitez;                        dst = dstadresz + i * roubitez;                                  for(j = 0; j < width; j++)            {                pix = n2get32(src);                rini = n2get32red(pix);                gini = n2get32green(pix);                bini = n2get32blue(pix);				memory_ONE(input,output);				xc=output[0]; 				yc=output[1]; 				zc=output[2]; 				n2set32m(dst,				         n2get32alpha(pix),				         n2klamp255( xc + redgain),				         n2klamp255( yc + greengain),				         n2klamp255( zc + bluegain));                input[0] = rini;                input[1] = gini;                input[2] = bini;				src+=4;				dst+=4;					             }		 }  	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}void nnato_processimage3(NNato *x, n2atom *data) {                       long           i, j, roubitez, pix, xc, yc, zc, rini, gini, bini;                               short          redgain   = x->redgain,     			   greengain = x->greengain,     			   bluegain  = x->bluegain,                   width, height, err;                        Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate, dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);	double  input[3],output[3];        if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.fid  : n2iensureimagedimeq err = %ld", err);             return;           }           if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;                         dstpixmap   = n2igetpixmap(dstgvelt);         srcpixztate = n2igetpixstate(srcpixmap);                dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;               if (!n2ilockpix(dstpixmap)) goto ikk;                      srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);                    for(i = 0; i < height; i++)          {            src = srcadresz + i * roubitez;                        dst = dstadresz + i * roubitez;                                  for(j = 0; j < width; j++)            {                pix = n2get32(src);                rini = n2get32red(pix);                gini = n2get32green(pix);                bini = n2get32blue(pix);				memory_ONE(input,output);				xc=output[0]; 				yc=output[1]; 				zc=output[2]; 				n2set32m(dst,				         n2get32alpha(pix),				         n2klamp255((xc + rini)/2 + redgain),				         n2klamp255((yc + gini)/2 + greengain),				         n2klamp255((zc + bini)/2 + bluegain));                input[0] = rini;                input[1] = gini;                input[2] = bini;				src+=4;				dst+=4;					             }		 }  	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}void nnato_processimage4(NNato *x, n2atom *data) {                       long           i, j, roubitez, pix, xc, yc, zc, rini, gini, bini;                               short          redgain   = x->redgain,     			   greengain = x->greengain,     			   bluegain  = x->bluegain,                   width, height, err;                        Ptr            src, dst, srcadresz, dstadresz;          n2pixmaphdl    srcpixmap, dstpixmap;    n2pixstate     srcpixztate, dstpixztate;    n2imgptr       dstgvelt, gveltptr = n2getatomimage(data);	double  input[3],output[3];        if (!x->on || !gveltptr) return;        if (x->freeze)           {                 n2registerimage(x,n2objtype,x->dataout,data,x->gvelt);              return;           }                       if (x->bypass)           {              n2registerimage(x,n2objtype,x->dataout,data,gveltptr);              return;              }         if ((err = n2iensuredimeq(&gveltptr,&x->gvelt)))           {             post ("242.fid  : n2iensureimagedimeq err = %ld", err);             return;           }           if (!x->think)                      srcpixmap   = n2igetpixmap(gveltptr);        else            srcpixmap   = n2igetpixmap(x->gvelt);               if (!x->quarrel)             dstgvelt = x->gvelt;        else            dstgvelt = gveltptr;                         dstpixmap   = n2igetpixmap(dstgvelt);         srcpixztate = n2igetpixstate(srcpixmap);                dstpixztate = n2igetpixstate(dstpixmap);                if (!n2ilockpix(srcpixmap)) return;               if (!n2ilockpix(dstpixmap)) goto ikk;                      srcadresz = n2igetpixaddr(srcpixmap);        dstadresz = n2igetpixaddr(dstpixmap);		roubitez  = n2igetpixrowbytes(srcpixmap);         n2igetdim(gveltptr,&width,&height);                    for(i = 0; i < height; i++)          {            src = srcadresz + i * roubitez;                        dst = dstadresz + i * roubitez;                                  for(j = 0; j < width; j++)            {                pix = n2get32(src);                rini = n2get32red(pix);                gini = n2get32green(pix);                bini = n2get32blue(pix);				memory_ONE(input,output);				xc=output[0]; 				yc=output[1]; 				zc=output[2]; 				n2set32m(dst,				         n2get32alpha(pix),				         n2klamp255(  rini + redgain),				         n2klamp255(    gini  + greengain),				         n2klamp255(  bini  + bluegain));                input[0] = rini;                input[1] = gini;                input[2] = bini;				src+=4;				dst+=4;					             }		 }  	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);        n2registerimage(x,n2objtype,x->dataout,data,dstgvelt);        return;        ikk: 	    n2isetpixstate(srcpixmap,srcpixztate);        n2isetpixstate(dstpixmap,dstpixztate);}